# Инструкции для продолжения работы над проектом AI Call

## ВАЖНОЕ ПРАВИЛО
Файл CONTINUATION_AGENT.md НЕ НУЖНО добавлять в репозиторий! Он находится вне папок репозитория и используется только для внутренней информации агента. Этот файл не должен быть зафиксирован в git и не должен отправляться в GitHub репозитории.

## Общая информация о проекте
Проект AI Call состоит из двух репозиториев:
- Backend: https://github.com/Alexdezton/ai-call-backend
- Frontend: https://github.com/Alexdezton/ai-call-frontend

Цель проекта: реализовать систему для двухсторонних звонков с реальным временем между двумя мобильными устройствами с использованием WebRTC и трансляцией через WebSocket сервер.

## Структура проекта
Проект разделен на две части:

1. ai-call-backend-local/: локальная папка для серверной части приложения
   - server.js: основной серверный файл с WebSocket-логикой
   - package.json: файл зависимостей
   - .git: репозиторий для деплоя на Render (https://github.com/Alexdezton/ai-call-backend)

2. ai-call-frontend-local/: локальная папка для клиентской части приложения
   - app.js: клиентская логика приложения
   - index.html: основная HTML-страница
   - manifest.json: файл манифеста для PWA
   - service-worker.js: сервис-воркер для PWA
   - assets/: папка с ресурсами
     - icons/: иконки для PWA
   - .git: репозиторий для деплоя на Netlify (https://github.com/Alexdezton/ai-call-frontend)

## Правила работы с проектом
1. НЕ ДОБАВЛЯТЬ файл CONTINUATION_AGENT.md в git-репозитории
2. ai-call-backend-local содержит только серверную часть (server.js, package.json)
3. ai-call-frontend-local содержит только клиентскую часть (app.js, index.html, и т.д.)
4. При внесении изменений убедиться, что вы работаете в правильной директории
5. Проверить, что изменения применяются к нужным файлам перед коммитом
6. Удалить скрытые .git папки из подкаталогов, чтобы избежать конфликта репозиториев
7. Для работы с backend использовать только папку ai-call-backend-local
8. Для работы с frontend использовать только папку ai-call-frontend-local

## Задачи для завершения

### 1. Исправление ошибок в backend (server.js)
- В строках 70 и 79 файл server.js использует переменную `userConnections.delete(userId)`, но правильное название переменной - `userConnections` (с маленькой буквы 'c'). Необходимо исправить обе строки.
- Проверить и исправить другие потенциальные опечатки в названиях переменных.

### 2. Реализация повторного подключения
- Обеспечить корректную обработку ситуации, когда пользователь подключается с другого устройства с тем же ID
- Сервер должен закрывать старое соединение и сохранять новое
- Уведомлять пользователя о подключении с другого устройства

### 3. Улучшение обработки комнат
- Удалять комнаты только при отсутствии активных WebSocket соединений
- Реализовать корректную очистку комнат при отключении всех участников
- Добавить логику проверки занятости комнаты (максимум 2 участника)

### 4. Обработка сообщений
- Обеспечить корректную обработку всех типов сообщений (JSON и бинарные данные)
- Добавить логирование всех входящих и исходящих сообщений
- Обрабатывать ошибки парсинга JSON без закрытия соединения

### 5. Разделение типов сообщений
- Разделить WebRTC сообщения (offer, answer, ice_candidate) от других типов
- Обеспечить корректную маршрутизацию сообщений между участниками одной комнаты

### 6. Вывод логов
- Добавить полные логи всех WebSocket событий на сервере
- Отправлять логи на фронтенд для отладки
- Реализовать отображение статусов подключения и звонка на интерфейсе

### 7. Совместимость с мобильными устройствами
- Проверить корректную работу WebRTC на мобильных браузерах
- Обеспечить стабильное соединение между двумя мобильными устройствами
- Протестировать производительность и задержки

### 8. Обновление фронтенда
- Убедиться, что интерфейс корректно отображает статусы подключения
- Реализовать отображение логов на главной странице
- Сделать кнопку "Start Call" активной только при наличии двух участников в комнате

## Архитектура системы
- Пользователи вводят Room ID для подключения к комнате
- User ID генерируется автоматически при загрузке страницы
- WebSocket соединение устанавливается с передачей User ID и Room ID в параметрах URL
- Сервер создает комнаты и связывает пользователей с одинаковыми Room ID
- WebRTC сообщения (offer, answer, ice_candidate) пересылаются между участниками одной комнаты
- При отключении одного пользователя второй получает уведомление

## Технические детали
- Backend: Node.js с использованием WebSocket (ws)
- Frontend: чистый JavaScript с WebRTC API
- Деплой backend на Render, frontend на Netlify
- Использование STUN сервера Google для WebRTC
- Автоматическая генерация User ID в формате "userXXX"

## Рекомендации по тестированию
1. Проверить подключение двух пользователей к одной комнате
2. Убедиться, что кнопка "Start Call" становится активной только при наличии двух участников
3. Проверить корректную передачу аудио между участниками
4. Протестировать отключение одного пользователя и уведомление второго
5. Проверить повторное подключение пользователя с другого устройства
6. Убедиться, что логи отображаются на фронтенде и в консоли